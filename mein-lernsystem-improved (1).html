<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Lernsystem - Complete App</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', sans-serif;
        }
        
        #root {
            width: 100%;
            max-width: 430px;
            height: 932px;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 480px) {
            #root {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }
            body {
                background: white;
            }
        }

        ::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Improve scrolling */
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        button {
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .checkmark-animation {
            animation: checkmark 0.3s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
            document.body.innerHTML = '<div style="padding: 20px; color: red; font-family: monospace;">Error: ' + msg + '<br>Check console for details (F12)</div>';
            return false;
        };

        console.log('Script starting...');
        
        const { useState, useEffect, useMemo, useRef } = React;
        console.log('React loaded:', !!React);
        
        // Icons
        const Home = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        );

        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
            </svg>
        );

        const Clock = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Play = ({ className }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
            </svg>
        );

        const Pause = ({ className }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const ChevronRight = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        const User = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        );

        const Trophy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
            </svg>
        );

        const BookOpen = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        // Utility Functions
        const getToday = () => {
            const today = new Date();
            return today.toISOString().split('T')[0];
        };

        const getDayName = (dateString) => {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const date = new Date(dateString);
            return days[date.getDay()];
        };

        const getDaysUntil = (dateString) => {
            const today = new Date(getToday());
            const target = new Date(dateString);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            return diff;
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('de-DE', options);
        };

        const formatTimer = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        // Weekly Plan Data (from PDF)
        const WEEKLY_PLAN = {
            monday: {
                subjects: ['Sport', 'Musik', 'Deutsch', 'PoWi'],
                focus: 'A: Englisch & Mathe (kurz) • B: Deutsch (klein)',
                tasks: [
                    { time: '14:45-15:00', activity: 'Aktivierung', description: 'Musik, Ball, Wasser', type: 'activation', points: 0, duration: 15 },
                    { time: '15:00-15:40', activity: 'Hausaufgaben', description: 'Aktuelle Aufgaben sauber & konzentriert', type: 'homework', points: 25, duration: 40 },
                    { time: '15:40-15:50', activity: 'Bewegungspause', description: 'Aktiv-Reset, kein Handy', type: 'break', points: 0, duration: 10 },
                    { time: '15:50-16:15', activity: 'Lernen', description: 'Englisch: Listening 10\' + 5 Sätze Writing; Mathe: 1 Fehler; Deutsch: 1 Mini-Formulierung', type: 'learning', points: 40, duration: 25 },
                    { time: '16:15-16:30', activity: 'Vorbereitung morgen', description: '5 Vokabeln, 1 Formel/Operator', type: 'preparation', points: 0, duration: 15 }
                ]
            },
            tuesday: {
                subjects: ['Französisch', 'Geschichte', 'Mathe', 'Englisch'],
                focus: 'A: Mathe & Englisch • B: Deutsch (Schreibtraining)',
                tasks: [
                    { time: '14:45-15:00', activity: 'Aktivierung', description: 'Musik, Ball, Wasser', type: 'activation', points: 0, duration: 15 },
                    { time: '15:00-15:40', activity: 'Hausaufgaben', description: 'Aktuelle Aufgaben sauber & konzentriert', type: 'homework', points: 25, duration: 40 },
                    { time: '15:40-15:50', activity: 'Bewegungspause', description: 'Aktiv-Reset, kein Handy', type: 'break', points: 0, duration: 10 },
                    { time: '15:50-16:15', activity: 'Lernen', description: 'Mathe: Fehlerheft (2 Aufgaben); Englisch: Writing 10\'; Deutsch: Einleitung/Operator', type: 'learning', points: 40, duration: 25 },
                    { time: '16:15-16:30', activity: 'Vorbereitung morgen', description: '5 Vokabeln, 1 Formel/Operator', type: 'preparation', points: 0, duration: 15 }
                ]
            },
            wednesday: {
                subjects: ['Englisch', 'PoWi', 'Geografie'],
                focus: 'A: Englisch • A: Mathe (kurz)',
                tasks: [
                    { time: '14:45-15:00', activity: 'Aktivierung', description: 'Musik, Ball, Wasser', type: 'activation', points: 0, duration: 15 },
                    { time: '15:00-15:40', activity: 'Hausaufgaben', description: 'Aktuelle Aufgaben sauber & konzentriert', type: 'homework', points: 25, duration: 40 },
                    { time: '15:40-15:50', activity: 'Bewegungspause', description: 'Aktiv-Reset, kein Handy', type: 'break', points: 0, duration: 10 },
                    { time: '15:50-16:15', activity: 'Lernen', description: 'Englisch: Reading + 5 Sätze Writing; Mathe: 1 Transferaufgabe', type: 'learning', points: 40, duration: 25 },
                    { time: '16:15-16:30', activity: 'Vorbereitung morgen', description: '5 Vokabeln, 1 Formel/Operator', type: 'preparation', points: 0, duration: 15 }
                ]
            },
            thursday: {
                subjects: ['Deutsch', 'Physik', 'Französisch', 'Mathe'],
                focus: 'B: Deutsch (Schreiben) • A: Mathe (kurz) • C: Physik nur HA',
                tasks: [
                    { time: '14:45-15:00', activity: 'Aktivierung', description: 'Musik, Ball, Wasser', type: 'activation', points: 0, duration: 15 },
                    { time: '15:00-15:40', activity: 'Hausaufgaben', description: 'Aktuelle Aufgaben sauber & konzentriert', type: 'homework', points: 25, duration: 40 },
                    { time: '15:40-15:50', activity: 'Bewegungspause', description: 'Aktiv-Reset, kein Handy', type: 'break', points: 0, duration: 10 },
                    { time: '15:50-16:15', activity: 'Lernen', description: 'Deutsch: 1 Argumentblock; Mathe: 1 Sicherungsaufgabe', type: 'learning', points: 40, duration: 25 },
                    { time: '16:15-16:30', activity: 'Vorbereitung morgen', description: '5 Vokabeln, 1 Formel/Operator', type: 'preparation', points: 0, duration: 15 }
                ]
            },
            friday: {
                subjects: ['Mathe', 'Chemie', 'Ethik'],
                focus: 'A: Mathe & Englisch • C: Nebenfächer nur HA',
                tasks: [
                    { time: '14:45-15:00', activity: 'Aktivierung', description: 'Musik, Ball, Wasser', type: 'activation', points: 0, duration: 15 },
                    { time: '15:00-15:40', activity: 'Hausaufgaben', description: 'Aktuelle Aufgaben sauber & konzentriert', type: 'homework', points: 25, duration: 40 },
                    { time: '15:40-15:50', activity: 'Bewegungspause', description: 'Aktiv-Reset, kein Handy', type: 'break', points: 0, duration: 10 },
                    { time: '15:50-16:15', activity: 'Lernen', description: 'Mathe: 1 Transferaufgabe; Englisch: Vocab-Review 10\'', type: 'learning', points: 40, duration: 25 },
                    { time: '16:15-16:30', activity: 'Vorbereitung morgen', description: '5 Vokabeln, 1 Formel/Operator', type: 'preparation', points: 0, duration: 15 }
                ]
            },
            saturday: {
                subjects: [],
                focus: 'Klausurwoche: Fokus auf Prüfungsfach',
                tasks: [
                    { time: '10:00-10:15', activity: 'Aktivierung', description: 'Musik, Bewegung', type: 'activation', points: 0, duration: 15 },
                    { time: '10:15-10:55', activity: 'Hausaufgaben', description: 'Falls noch offen', type: 'homework', points: 25, duration: 40 },
                    { time: '10:55-11:05', activity: 'Pause', description: 'Aktiv-Reset', type: 'break', points: 0, duration: 10 },
                    { time: '11:05-11:30', activity: 'Klausur-Fokus', description: 'Countdown-basiertes Lernen', type: 'exam-prep', points: 40, duration: 25 }
                ]
            },
            sunday: {
                subjects: [],
                focus: 'Klausurwoche: Letzte Vorbereitung',
                tasks: [
                    { time: '10:00-10:15', activity: 'Aktivierung', description: 'Ruhe & Fokus', type: 'activation', points: 0, duration: 15 },
                    { time: '10:15-10:40', activity: 'Klausur-Fokus', description: 'Abruf & Ruhe', type: 'exam-prep', points: 40, duration: 25 }
                ]
            }
        };

        // Exam Countdown Plan
        const EXAM_COUNTDOWN = {
            6: { 
                phase: 'Überblick', 
                description: 'Themenliste, alte Tests, Material sammeln', 
                color: 'bg-blue-100',
                tasks: ['Alle Themen auflisten', 'Alte Arbeiten sichten', 'Lücken identifizieren'],
                icon: '📋'
            },
            5: { 
                phase: 'Grundlagen', 
                description: 'Theorie & einfache Aufgaben wiederholen', 
                color: 'bg-green-100',
                tasks: ['Theorie durcharbeiten', '2-3 Basisaufgaben pro Thema', 'Karteikarten erstellen'],
                icon: '📚'
            },
            4: { 
                phase: 'Anwendung', 
                description: 'Übungen mittlerer Schwierigkeit', 
                color: 'bg-yellow-100',
                tasks: ['Gemischte Aufgaben lösen', 'Textproduktion üben', 'Vokabel-Cluster wiederholen'],
                icon: '✍️'
            },
            3: { 
                phase: 'Fehleranalyse', 
                description: 'Falsche Aufgaben neu lösen', 
                color: 'bg-orange-100',
                tasks: ['Fehlerheft durchgehen', 'Fehlerursachen notieren', 'Gegenstrategie entwickeln'],
                icon: '🔍'
            },
            2: { 
                phase: 'Abruftraining', 
                description: 'Karteikarten, Probeaufgabe mit Zeitlimit', 
                color: 'bg-red-100',
                tasks: ['Probetest unter Zeitdruck', 'Karteikarten wiederholen', 'Laut erklären (Teacher-Mode)'],
                icon: '⏱️'
            },
            1: { 
                phase: 'Ruhe & Übersicht', 
                description: 'Formeln/Vokabeln wiederholen, früh schlafen', 
                color: 'bg-purple-100',
                tasks: ['Formeln/Vokabeln wiederholen', 'Material ordnen', 'Früh schlafen gehen'],
                icon: '🧘'
            },
            0: {
                phase: 'Klausurtag',
                description: 'Ruhig bleiben, Materialien prüfen',
                color: 'bg-indigo-100',
                tasks: ['Material einpacken', 'Frühstücken', 'Positiv denken'],
                icon: '🎯'
            }
        };

        // Main App Component
        const LernsystemApp = () => {
            const [currentScreen, setCurrentScreen] = useState('dashboard');
            const [exams, setExams] = useState([]);
            const [dailyTasks, setDailyTasks] = useState({});
            const [weeklyPoints, setWeeklyPoints] = useState({ earned: 0, total: 325 });
            const [showAddExam, setShowAddExam] = useState(false);
            const [activeTaskTimer, setActiveTaskTimer] = useState(null);
            const [timerSeconds, setTimerSeconds] = useState(0);
            const timerIntervalRef = useRef(null);

            // Load data from localStorage on mount
            useEffect(() => {
                try {
                    const savedExams = localStorage.getItem('exams');
                    const savedTasks = localStorage.getItem('dailyTasks');
                    const savedPoints = localStorage.getItem('weeklyPoints');
                    
                    if (savedExams) {
                        try {
                            setExams(JSON.parse(savedExams));
                        } catch (e) {
                            console.error('Error parsing exams:', e);
                        }
                    }
                    
                    if (savedTasks) {
                        try {
                            const tasks = JSON.parse(savedTasks);
                            setDailyTasks(tasks);
                            
                            // Check if today's tasks exist
                            const today = getToday();
                            if (!tasks[today]) {
                                initializeTodayTasks();
                            }
                        } catch (e) {
                            console.error('Error parsing tasks:', e);
                            initializeTodayTasks();
                        }
                    } else {
                        initializeTodayTasks();
                    }
                    
                    if (savedPoints) {
                        try {
                            setWeeklyPoints(JSON.parse(savedPoints));
                        } catch (e) {
                            console.error('Error parsing points:', e);
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }, []);

            // Save data to localStorage
            useEffect(() => {
                if (exams.length > 0) {
                    localStorage.setItem('exams', JSON.stringify(exams));
                }
            }, [exams]);

            useEffect(() => {
                if (Object.keys(dailyTasks).length > 0) {
                    localStorage.setItem('dailyTasks', JSON.stringify(dailyTasks));
                }
            }, [dailyTasks]);

            useEffect(() => {
                localStorage.setItem('weeklyPoints', JSON.stringify(weeklyPoints));
            }, [weeklyPoints]);

            // Timer effect - optimized to prevent scroll jumping
            useEffect(() => {
                if (activeTaskTimer) {
                    timerIntervalRef.current = setInterval(() => {
                        setTimerSeconds(prev => prev + 1);
                    }, 1000);
                } else {
                    if (timerIntervalRef.current) {
                        clearInterval(timerIntervalRef.current);
                    }
                }
                return () => {
                    if (timerIntervalRef.current) {
                        clearInterval(timerIntervalRef.current);
                    }
                };
            }, [activeTaskTimer]);

            // Re-initialize tasks when exams change
            useEffect(() => {
                const today = getToday();
                if (dailyTasks[today] && exams.length > 0) {
                    initializeTodayTasks();
                }
            }, [exams]);

            const initializeTodayTasks = () => {
                const today = getToday();
                const dayName = getDayName(today).toLowerCase();
                
                // Map German day names to English keys
                const dayMapping = {
                    'montag': 'monday',
                    'dienstag': 'tuesday',
                    'mittwoch': 'wednesday',
                    'donnerstag': 'thursday',
                    'freitag': 'friday',
                    'samstag': 'saturday',
                    'sonntag': 'sunday'
                };
                
                const mappedDay = dayMapping[dayName] || 'monday';
                const dayPlan = WEEKLY_PLAN[mappedDay] || WEEKLY_PLAN.monday;
                
                // Check for active exams
                const activeExams = exams
                    .map(exam => ({
                        ...exam,
                        daysUntil: getDaysUntil(exam.date)
                    }))
                    .filter(exam => exam.daysUntil >= 0 && exam.daysUntil <= 6)
                    .sort((a, b) => {
                        if (a.priority !== b.priority) {
                            return a.priority.localeCompare(b.priority);
                        }
                        return a.daysUntil - b.daysUntil;
                    });

                let tasks = dayPlan.tasks.map((task, index) => ({
                    ...task,
                    id: `${today}-${index}-${Date.now()}`,
                    date: today,
                    status: 'pending'
                }));

                // If there's an active exam, modify the learning task
                if (activeExams.length > 0) {
                    const primaryExam = activeExams[0];
                    const countdown = EXAM_COUNTDOWN[primaryExam.daysUntil] || EXAM_COUNTDOWN[1];
                    
                    // Find and replace the learning task
                    tasks = tasks.map(task => {
                        if (task.type === 'learning' || task.type === 'exam-prep') {
                            return {
                                ...task,
                                activity: `🔥 Klausur-Fokus: ${primaryExam.subject}`,
                                description: `Tag -${primaryExam.daysUntil}: ${countdown.phase} - ${countdown.description}`,
                                type: 'exam-prep',
                                examSubject: primaryExam.subject,
                                examPhase: countdown.phase,
                                examTasks: countdown.tasks,
                                examIcon: countdown.icon
                            };
                        }
                        return task;
                    });

                    // For vocab tests (day -3 to 0), add a note
                    const vocabTests = exams
                        .map(exam => ({
                            ...exam,
                            daysUntil: getDaysUntil(exam.date)
                        }))
                        .filter(exam => exam.type === 'Vokabeltest' && exam.daysUntil >= 0 && exam.daysUntil <= 3);

                    if (vocabTests.length > 0) {
                        // Add vocab test reminder to preparation task
                        tasks = tasks.map(task => {
                            if (task.type === 'preparation') {
                                const vocabReminders = vocabTests.map(v => 
                                    `${v.subject} Vokabeltest (${v.daysUntil} Tage)`
                                ).join(', ');
                                return {
                                    ...task,
                                    description: `${task.description} | ⚠️ Vokabeltests: ${vocabReminders}`
                                };
                            }
                            return task;
                        });
                    }
                }

                console.log('Initializing tasks for', today, ':', tasks);

                setDailyTasks(prev => ({
                    ...prev,
                    [today]: tasks
                }));
            };

            const addExam = (examData) => {
                console.log('Adding exam to list:', examData);
                const newExam = {
                    ...examData,
                    id: Date.now().toString()
                };
                console.log('New exam with ID:', newExam);
                setExams(prev => {
                    const updated = [...prev, newExam];
                    console.log('Updated exams list:', updated);
                    return updated;
                });
                setShowAddExam(false);
                
                // Show success message
                setTimeout(() => {
                    alert(`✅ ${examData.subject} ${examData.type} erfolgreich hinzugefügt!`);
                }, 100);
            };

            const deleteExam = (id) => {
                setExams(prev => prev.filter(exam => exam.id !== id));
            };

            const startTask = (taskId) => {
                const today = getToday();
                const scrollContainer = document.querySelector('.overflow-y-auto');
                const scrollPosition = scrollContainer ? scrollContainer.scrollTop : 0;
                
                setDailyTasks(prev => ({
                    ...prev,
                    [today]: prev[today].map(task => 
                        task.id === taskId 
                            ? { ...task, status: 'active', startTime: Date.now() }
                            : task
                    )
                }));
                setActiveTaskTimer(taskId);
                setTimerSeconds(0);
                
                // Restore scroll position after state update
                setTimeout(() => {
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollPosition;
                    }
                }, 0);
            };

            const pauseTask = (taskId) => {
                const scrollContainer = document.querySelector('.overflow-y-auto');
                const scrollPosition = scrollContainer ? scrollContainer.scrollTop : 0;
                
                setActiveTaskTimer(null);
                
                setTimeout(() => {
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollPosition;
                    }
                }, 0);
            };

            const completeTask = (taskId) => {
                const today = getToday();
                const task = dailyTasks[today]?.find(t => t.id === taskId);
                const scrollContainer = document.querySelector('.overflow-y-auto');
                const scrollPosition = scrollContainer ? scrollContainer.scrollTop : 0;
                
                if (task) {
                    setDailyTasks(prev => ({
                        ...prev,
                        [today]: prev[today].map(t => 
                            t.id === taskId 
                                ? { ...t, status: 'completed' }
                                : t
                        )
                    }));

                    // Add points
                    setWeeklyPoints(prev => ({
                        ...prev,
                        earned: prev.earned + task.points
                    }));

                    setActiveTaskTimer(null);
                    setTimerSeconds(0);
                }
                
                setTimeout(() => {
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollPosition;
                    }
                }, 0);
            };

            const getTodayTasks = () => {
                const today = getToday();
                const tasks = dailyTasks[today];
                
                if (!tasks || tasks.length === 0) {
                    // If no tasks exist for today, initialize them
                    const dayName = getDayName(today).toLowerCase();
                    
                    // Map German day names to English keys
                    const dayMapping = {
                        'montag': 'monday',
                        'dienstag': 'tuesday',
                        'mittwoch': 'wednesday',
                        'donnerstag': 'thursday',
                        'freitag': 'friday',
                        'samstag': 'saturday',
                        'sonntag': 'sunday'
                    };
                    
                    const mappedDay = dayMapping[dayName] || 'monday';
                    const dayPlan = WEEKLY_PLAN[mappedDay] || WEEKLY_PLAN.monday;
                    
                    const newTasks = dayPlan.tasks.map((task, index) => ({
                        ...task,
                        id: `${today}-${index}`,
                        date: today,
                        status: 'pending'
                    }));
                    
                    setDailyTasks(prev => ({
                        ...prev,
                        [today]: newTasks
                    }));
                    
                    return newTasks;
                }
                
                return tasks;
            };

            const getActiveExams = () => {
                return exams
                    .map(exam => ({
                        ...exam,
                        daysUntil: getDaysUntil(exam.date)
                    }))
                    .filter(exam => exam.daysUntil >= 0 && exam.daysUntil <= 6)
                    .sort((a, b) => {
                        // Sort by priority (A > B > C) and then by days
                        if (a.priority !== b.priority) {
                            return a.priority.localeCompare(b.priority);
                        }
                        return a.daysUntil - b.daysUntil;
                    });
            };

            const getUpcomingExams = () => {
                return exams
                    .map(exam => ({
                        ...exam,
                        daysUntil: getDaysUntil(exam.date)
                    }))
                    .filter(exam => exam.daysUntil >= 0)
                    .sort((a, b) => a.daysUntil - b.daysUntil);
            };

            const rewardUnlocked = weeklyPoints.earned >= weeklyPoints.total * 0.8;

            // Dashboard Screen
            const DashboardScreen = () => {
                const todayTasks = getTodayTasks();
                const activeExams = getActiveExams();
                const upcomingExams = getUpcomingExams();
                const completedToday = todayTasks.filter(t => t.status === 'completed').length;
                const totalToday = todayTasks.length;
                const todayPoints = todayTasks.reduce((sum, t) => t.status === 'completed' ? sum + t.points : sum, 0);

                return (
                    <div className="h-screen flex flex-col bg-gray-50">
                        <div className="bg-white px-6 pt-12 pb-6 flex-shrink-0">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-4xl font-bold">Dashboard</h1>
                                <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                                    <User className="w-7 h-7 text-white" />
                                </div>
                            </div>
                            <h2 className="text-3xl font-semibold mb-2">Hello, Max</h2>
                            <p className="text-gray-500 text-lg">Let's stay focused today!</p>
                        </div>

                        <div className="flex-1 overflow-y-auto pb-24">
                            {/* Weekly Points Progress */}
                            <div className="mx-4 mt-6 bg-gradient-to-r from-blue-500 to-purple-500 rounded-3xl p-6 text-white shadow-lg">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 className="text-2xl font-bold">{weeklyPoints.earned} / {weeklyPoints.total}</h3>
                                        <p className="text-blue-100">Punkte diese Woche</p>
                                    </div>
                                    {rewardUnlocked && (
                                        <div className="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center">
                                            <Trophy className="w-10 h-10 text-white" />
                                        </div>
                                    )}
                                </div>
                                <div className="w-full bg-white/30 rounded-full h-3">
                                    <div 
                                        className="bg-white h-3 rounded-full transition-all duration-500"
                                        style={{ width: `${(weeklyPoints.earned / weeklyPoints.total) * 100}%` }}
                                    ></div>
                                </div>
                                <p className="text-sm text-blue-100 mt-2">
                                    {rewardUnlocked ? '🎉 Belohnung freigeschaltet!' : `${Math.round((weeklyPoints.earned / weeklyPoints.total) * 100)}% - Noch ${Math.ceil(weeklyPoints.total * 0.8 - weeklyPoints.earned)} Punkte bis zur Belohnung`}
                                </p>
                            </div>

                            {/* Active Exams Countdown */}
                            {activeExams.length > 0 && (
                                <div className="mx-4 mt-6 bg-white rounded-3xl p-6 shadow-sm">
                                    <h3 className="text-2xl font-semibold mb-4">🔥 Aktive Klausurpläne</h3>
                                    {activeExams.map(exam => {
                                        const countdown = EXAM_COUNTDOWN[exam.daysUntil] || EXAM_COUNTDOWN[1];
                                        return (
                                            <div key={exam.id} className={`mb-3 p-4 rounded-xl ${countdown.color}`}>
                                                <div className="flex items-center justify-between mb-2">
                                                    <h4 className="text-lg font-semibold">{exam.subject}</h4>
                                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                        exam.priority === 'A' ? 'bg-blue-500 text-white' :
                                                        exam.priority === 'B' ? 'bg-green-500 text-white' :
                                                        'bg-gray-400 text-white'
                                                    }`}>
                                                        {exam.priority}
                                                    </span>
                                                </div>
                                                <p className="text-gray-700 font-medium">Tag -{exam.daysUntil}: {countdown.phase}</p>
                                                <p className="text-sm text-gray-600 mt-1">{countdown.description}</p>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Today's Tasks Overview */}
                            <div className="mx-4 mt-6 bg-white rounded-3xl p-6 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-2xl font-semibold">Heutige Aufgaben</h3>
                                    <div className="text-right">
                                        <div className="text-2xl font-bold text-blue-500">{todayPoints} Pkt</div>
                                        <div className="text-sm text-gray-500">{completedToday}/{totalToday}</div>
                                    </div>
                                </div>

                                {/* Task List Preview */}
                                <div className="space-y-3 mb-4">
                                    {todayTasks.slice(0, 5).map(task => (
                                        <div key={task.id} className="flex items-center gap-3">
                                            {task.status === 'completed' ? (
                                                <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0" />
                                            ) : task.status === 'active' ? (
                                                <div className="w-6 h-6 bg-blue-500 rounded-full flex-shrink-0 pulse-animation"></div>
                                            ) : (
                                                <div className="w-6 h-6 border-2 border-gray-300 rounded-full flex-shrink-0"></div>
                                            )}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-sm font-medium truncate ${task.status === 'completed' ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                                        {task.activity}
                                                    </span>
                                                    {task.points > 0 && task.status !== 'completed' && (
                                                        <span className="text-xs text-blue-600 font-medium flex-shrink-0">+{task.points}</span>
                                                    )}
                                                </div>
                                                <span className="text-xs text-gray-500">{task.time}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button 
                                    onClick={() => setCurrentScreen('tasks')}
                                    className="w-full bg-blue-500 text-white py-4 rounded-2xl text-lg font-semibold hover:bg-blue-600 transition-colors"
                                >
                                    Alle Aufgaben anzeigen
                                </button>
                            </div>

                            {/* Upcoming Exams */}
                            {upcomingExams.length > 0 && (
                                <div className="mx-4 mt-6 mb-6 bg-white rounded-3xl p-6 shadow-sm">
                                    <h3 className="text-2xl font-semibold mb-4">Bevorstehend</h3>
                                    {upcomingExams.slice(0, 3).map(exam => (
                                        <div key={exam.id} className="flex items-center gap-4 mb-4 last:mb-0">
                                            <div className="w-14 h-14 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                                                <BookOpen className="w-7 h-7 text-white" />
                                            </div>
                                            <div className="flex-1">
                                                <h4 className="text-xl font-semibold">{exam.subject} {exam.type}</h4>
                                                <p className="text-gray-500">
                                                    {formatDate(exam.date)} • {exam.daysUntil} {exam.daysUntil === 1 ? 'Tag' : 'Tage'} verbleibend
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Tasks Screen (Daily Plan)
            const TasksScreen = () => {
                const todayTasks = getTodayTasks();
                const today = getToday();

                return (
                    <div className="h-screen flex flex-col bg-gray-50">
                        <div className="bg-white px-6 pt-12 pb-6 flex-shrink-0">
                            <div className="flex items-center mb-6">
                                <button onClick={() => setCurrentScreen('dashboard')} className="mr-4">
                                    <ChevronRight className="w-6 h-6 rotate-180 text-gray-800" />
                                </button>
                                <h1 className="text-2xl font-semibold">TAGESPLAN</h1>
                            </div>
                            <p className="text-lg text-gray-600">{formatDate(today)}</p>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 py-6 pb-24">
                            <div className="space-y-4">
                                {todayTasks.map(task => (
                                    <TaskCard 
                                        key={task.id}
                                        task={task}
                                        isActive={activeTaskTimer === task.id}
                                        timerSeconds={activeTaskTimer === task.id ? timerSeconds : 0}
                                        onStart={() => startTask(task.id)}
                                        onPause={() => pauseTask(task.id)}
                                        onComplete={() => completeTask(task.id)}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // Task Card Component - Memoized to prevent unnecessary re-renders
            const TaskCard = React.memo(({ task, isActive, timerSeconds, onStart, onPause, onComplete }) => {
                const statusColors = {
                    pending: 'border-gray-300',
                    active: 'border-blue-500 bg-blue-50',
                    completed: 'border-green-500 bg-green-50'
                };

                return (
                    <div className={`bg-white rounded-2xl p-5 border-2 ${statusColors[task.status]} transition-all`}>
                        <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                    {task.status === 'completed' ? (
                                        <CheckCircle className="w-7 h-7 text-green-500 checkmark-animation" />
                                    ) : task.status === 'active' ? (
                                        <div className="w-7 h-7 bg-blue-500 rounded-full pulse-animation"></div>
                                    ) : (
                                        <div className="w-7 h-7 border-2 border-gray-300 rounded-full"></div>
                                    )}
                                    <div className="flex-1">
                                        <h3 className="text-xl font-semibold">{task.activity}</h3>
                                        {task.examIcon && (
                                            <span className="text-2xl">{task.examIcon}</span>
                                        )}
                                    </div>
                                </div>
                                <p className="text-gray-600 ml-10">{task.description}</p>
                                
                                {/* Show exam tasks if available */}
                                {task.examTasks && (
                                    <div className="ml-10 mt-3 p-3 bg-white rounded-xl border border-gray-200">
                                        <p className="text-xs font-semibold text-gray-700 mb-2">Heute fokussieren:</p>
                                        <ul className="space-y-1">
                                            {task.examTasks.map((t, i) => (
                                                <li key={i} className="text-xs text-gray-600 flex items-start gap-2">
                                                    <span className="text-blue-500 font-bold">•</span>
                                                    <span>{t}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                
                                <div className="flex items-center gap-4 ml-10 mt-2 text-sm text-gray-500">
                                    <span>⏰ {task.time}</span>
                                    {task.points > 0 && (
                                        <span className="font-medium text-blue-600">+{task.points} Punkte</span>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Timer Display */}
                        {isActive && (
                            <div className="bg-blue-100 rounded-xl p-3 mb-3">
                                <div className="flex items-center justify-between">
                                    <span className="text-gray-700">Laufzeit:</span>
                                    <span className="text-2xl font-bold text-blue-600">{formatTimer(timerSeconds)}</span>
                                </div>
                            </div>
                        )}

                        {/* Action Buttons */}
                        {task.status === 'pending' && (
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onStart();
                                }}
                                className="w-full bg-blue-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-blue-600 transition-colors"
                            >
                                <Play className="w-5 h-5" />
                                Starten
                            </button>
                        )}

                        {task.status === 'active' && (
                            <div className="flex gap-2">
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        onPause();
                                    }}
                                    className="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-yellow-600 transition-colors"
                                >
                                    <Pause className="w-5 h-5" />
                                    Pause
                                </button>
                                <button
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        onComplete();
                                    }}
                                    className="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-green-600 transition-colors"
                                >
                                    <CheckCircle className="w-5 h-5" />
                                    Erledigt
                                </button>
                            </div>
                        )}

                        {task.status === 'completed' && (
                            <div className="bg-green-100 text-green-700 py-3 rounded-xl font-semibold text-center">
                                ✅ Abgeschlossen
                            </div>
                        )}
                    </div>
                );
            });

            // Helper function to get tasks preview for a specific date
            const getTasksForDate = (dateString) => {
                const dayName = getDayName(dateString).toLowerCase();
                const dayMapping = {
                    'montag': 'monday',
                    'dienstag': 'tuesday',
                    'mittwoch': 'wednesday',
                    'donnerstag': 'thursday',
                    'freitag': 'friday',
                    'samstag': 'saturday',
                    'sonntag': 'sunday'
                };
                
                const mappedDay = dayMapping[dayName] || 'monday';
                const dayPlan = WEEKLY_PLAN[mappedDay] || WEEKLY_PLAN.monday;
                
                // Check for active exams on that date
                const activeExamsOnDate = exams
                    .map(exam => ({ ...exam, daysUntil: getDaysUntil(exam.date) }))
                    .filter(exam => {
                        const examDate = new Date(exam.date);
                        const checkDate = new Date(dateString);
                        const daysDiff = Math.ceil((examDate - checkDate) / (1000 * 60 * 60 * 24));
                        return daysDiff >= 0 && daysDiff <= 6;
                    })
                    .sort((a, b) => {
                        if (a.priority !== b.priority) return a.priority.localeCompare(b.priority);
                        return a.daysUntil - b.daysUntil;
                    });

                let tasks = dayPlan.tasks;
                
                // Modify if there's an active exam
                if (activeExamsOnDate.length > 0) {
                    const primaryExam = activeExamsOnDate[0];
                    const examDate = new Date(primaryExam.date);
                    const checkDate = new Date(dateString);
                    const daysDiff = Math.ceil((examDate - checkDate) / (1000 * 60 * 60 * 24));
                    const countdown = EXAM_COUNTDOWN[daysDiff] || EXAM_COUNTDOWN[1];
                    
                    tasks = tasks.map(task => {
                        if (task.type === 'learning' || task.type === 'exam-prep') {
                            return {
                                ...task,
                                activity: `🔥 Klausur-Fokus: ${primaryExam.subject}`,
                                description: `${countdown.phase}`,
                                type: 'exam-prep',
                                examIcon: countdown.icon
                            };
                        }
                        return task;
                    });
                }
                
                return tasks.filter(t => t.points > 0); // Only show tasks with points
            };

            // Get next 7 days
            const getNext7Days = () => {
                const days = [];
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    days.push(date.toISOString().split('T')[0]);
                }
                return days;
            };

            // Calendar Screen
            const CalendarScreen = () => {
                const upcomingExams = getUpcomingExams();
                const next7Days = getNext7Days();
                const today = getToday();

                return (
                    <div className="h-screen flex flex-col bg-gray-50">
                        <div className="bg-white px-6 pt-12 pb-6 flex-shrink-0">
                            <div className="flex items-center justify-between mb-6">
                                <h1 className="text-3xl font-bold">Kalender</h1>
                                <button
                                    onClick={() => setShowAddExam(true)}
                                    className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center hover:bg-blue-600 transition-colors"
                                >
                                    <Plus className="w-7 h-7 text-white" />
                                </button>
                            </div>
                            <p className="text-gray-500 text-lg">Nächste 7 Tage & Prüfungen</p>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 py-6 pb-24">
                            {/* Week Preview */}
                            <div className="mb-6">
                                <h3 className="text-xl font-bold mb-4">Wochenvorschau</h3>
                                <div className="space-y-3">
                                    {next7Days.map(dateString => {
                                        const tasks = getTasksForDate(dateString);
                                        const isToday = dateString === today;
                                        const dayName = getDayName(dateString);
                                        const date = new Date(dateString);
                                        const dayMonth = date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' });
                                        
                                        return (
                                            <div 
                                                key={dateString} 
                                                className={`bg-white rounded-2xl p-4 shadow-sm ${isToday ? 'ring-2 ring-blue-500' : ''}`}
                                            >
                                                <div className="flex items-center justify-between mb-3">
                                                    <div>
                                                        <h4 className="font-bold text-lg">
                                                            {dayName}
                                                            {isToday && <span className="ml-2 text-blue-500 text-sm">Heute</span>}
                                                        </h4>
                                                        <p className="text-sm text-gray-500">{dayMonth}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-sm font-semibold text-blue-600">
                                                            {tasks.reduce((sum, t) => sum + t.points, 0)} Pkt
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2">
                                                    {tasks.slice(0, 3).map((task, idx) => (
                                                        <div key={idx} className="flex items-center gap-2 text-sm">
                                                            <div className="w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0" />
                                                            <span className="text-gray-700 truncate flex-1">{task.activity}</span>
                                                            {task.points > 0 && (
                                                                <span className="text-xs text-blue-600 font-bold">+{task.points}</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                    {tasks.length > 3 && (
                                                        <p className="text-xs text-gray-500 ml-7">
                                                            +{tasks.length - 3} weitere Aufgaben
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Upcoming Exams */}
                            <div>
                                <h3 className="text-xl font-bold mb-4">Bevorstehende Prüfungen</h3>
                                {upcomingExams.length === 0 ? (
                                    <div className="bg-white rounded-3xl p-8 text-center">
                                        <Calendar className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                        <p className="text-gray-500 text-lg">Keine bevorstehenden Termine</p>
                                        <button
                                            onClick={() => setShowAddExam(true)}
                                            className="mt-4 px-6 py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors"
                                        >
                                            Ersten Termin hinzufügen
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {upcomingExams.map(exam => (
                                            <ExamCard 
                                                key={exam.id} 
                                                exam={exam} 
                                                onDelete={() => deleteExam(exam.id)}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Add Exam Modal */}
                        {showAddExam && (
                            <AddExamModal 
                                onClose={() => setShowAddExam(false)}
                                onAdd={addExam}
                            />
                        )}
                    </div>
                );
            };

            // Exam Card Component
            const ExamCard = ({ exam, onDelete }) => {
                const priorityColors = {
                    A: 'bg-blue-500',
                    B: 'bg-green-500',
                    C: 'bg-gray-400'
                };

                const isActive = exam.daysUntil >= 0 && exam.daysUntil <= 6;

                return (
                    <div className={`bg-white rounded-3xl p-5 shadow-sm ${isActive ? 'ring-2 ring-blue-500' : ''}`}>
                        <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                    <div className={`w-12 h-12 ${priorityColors[exam.priority]} rounded-full flex items-center justify-center`}>
                                        <BookOpen className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-semibold">{exam.subject}</h3>
                                        <p className="text-gray-500">{exam.type}</p>
                                    </div>
                                </div>
                            </div>
                            <button
                                onClick={onDelete}
                                className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                            >
                                <Trash className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <span className="text-gray-600">Datum:</span>
                                <span className="font-medium">{formatDate(exam.date)}</span>
                            </div>
                            <div className="flex items-center justify-between">
                                <span className="text-gray-600">In:</span>
                                <span className="font-medium">{exam.daysUntil} {exam.daysUntil === 1 ? 'Tag' : 'Tagen'}</span>
                            </div>
                            <div className="flex items-center justify-between">
                                <span className="text-gray-600">Priorität:</span>
                                <span className={`px-3 py-1 rounded-full text-sm font-medium text-white ${priorityColors[exam.priority]}`}>
                                    {exam.priority}-Fach
                                </span>
                            </div>
                        </div>

                        {isActive && (
                            <div className="mt-4 p-3 bg-blue-50 rounded-xl">
                                <p className="text-sm font-medium text-blue-700">
                                    🔥 Lernplan aktiv: Tag -{exam.daysUntil}
                                </p>
                            </div>
                        )}

                        {exam.type === 'Vokabeltest' && exam.daysUntil <= 3 && exam.daysUntil >= 0 && (
                            <div className="mt-4 p-3 bg-yellow-50 rounded-xl">
                                <p className="text-sm font-medium text-yellow-700">
                                    ⚠️ Vokabeltest-Vorbereitung läuft
                                </p>
                            </div>
                        )}
                    </div>
                );
            };

            // Add Exam Modal Component
            const AddExamModal = ({ onClose, onAdd }) => {
                const [formData, setFormData] = useState({
                    subject: '',
                    type: 'Klausur',
                    date: '',
                    priority: 'A',
                    topics: ''
                });

                const subjects = [
                    { name: 'Mathe', priority: 'A' },
                    { name: 'Englisch', priority: 'A' },
                    { name: 'Deutsch', priority: 'B' },
                    { name: 'Französisch', priority: 'C' },
                    { name: 'Geschichte', priority: 'C' },
                    { name: 'PoWi', priority: 'C' },
                    { name: 'Geografie', priority: 'C' },
                    { name: 'Physik', priority: 'C' },
                    { name: 'Chemie', priority: 'C' },
                    { name: 'Ethik', priority: 'C' }
                ];

                const handleSubmit = (e) => {
                    e.preventDefault();
                    console.log('Form submitted with data:', formData);
                    
                    if (!formData.subject) {
                        alert('Bitte wähle ein Fach aus');
                        return;
                    }
                    if (!formData.date) {
                        alert('Bitte wähle ein Datum aus');
                        return;
                    }
                    
                    // Create exam object with all required fields
                    const examData = {
                        subject: formData.subject,
                        type: formData.type,
                        date: formData.date,
                        priority: formData.priority,
                        topics: formData.topics || ''
                    };
                    
                    console.log('Adding exam:', examData);
                    onAdd(examData);
                };

                const handleSubjectChange = (subject) => {
                    const subjectData = subjects.find(s => s.name === subject);
                    setFormData(prev => ({
                        ...prev,
                        subject,
                        priority: subjectData?.priority || 'A'
                    }));
                };

                return (
                    <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50" onClick={(e) => {
                        // Only close if clicking on the backdrop, not the modal content
                        if (e.target === e.currentTarget) {
                            onClose();
                        }
                    }}>
                        <div className="bg-white rounded-t-3xl w-full max-w-md p-6 animate-slide-up" onClick={(e) => e.stopPropagation()}>
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold">Neuer Termin</h2>
                                <button 
                                    onClick={onClose} 
                                    className="text-gray-500 text-3xl hover:text-gray-700 transition-colors"
                                    type="button"
                                >
                                    &times;
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Fach <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.subject}
                                        onChange={(e) => handleSubjectChange(e.target.value)}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
                                        required
                                    >
                                        <option value="">Fach wählen...</option>
                                        {subjects.map(s => (
                                            <option key={s.name} value={s.name}>
                                                {s.name} ({s.priority}-Fach)
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Typ</label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
                                    >
                                        <option value="Klausur">Klausur</option>
                                        <option value="Vokabeltest">Vokabeltest</option>
                                        <option value="Kurztest">Kurztest</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Datum <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
                                        min={getToday()}
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Themen (optional)</label>
                                    <textarea
                                        value={formData.topics}
                                        onChange={(e) => setFormData(prev => ({ ...prev, topics: e.target.value }))}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
                                        rows="2"
                                        placeholder="z.B. Quadratische Funktionen, Kapitel 3..."
                                    />
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="flex-1 bg-gray-200 text-gray-700 py-4 rounded-xl text-lg font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                        Abbrechen
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 bg-blue-500 text-white py-4 rounded-xl text-lg font-semibold hover:bg-blue-600 transition-colors"
                                    >
                                        Hinzufügen
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            // Profile Screen (simplified)
            const ProfileScreen = () => (
                <div className="h-screen flex flex-col bg-gray-50">
                    <div className="bg-white px-6 pt-12 pb-6 flex-shrink-0">
                        <h1 className="text-3xl font-bold">Einstellungen</h1>
                    </div>
                    <div className="flex-1 overflow-y-auto px-6 py-6 pb-24">
                        <div className="bg-white rounded-3xl p-6 shadow-sm">
                            <p className="text-gray-600">Einstellungen werden in der nächsten Version verfügbar sein.</p>
                        </div>
                    </div>
                </div>
            );

            // Bottom Navigation
            const BottomNav = () => (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-around items-center max-w-md mx-auto" style={{ zIndex: 1000 }}>
                    <button 
                        onClick={() => setCurrentScreen('dashboard')}
                        className={`flex flex-col items-center gap-1 transition-colors ${currentScreen === 'dashboard' ? 'text-blue-500' : 'text-gray-400'}`}
                    >
                        <Home className="w-6 h-6" />
                        <span className="text-xs font-medium">Home</span>
                    </button>
                    <button 
                        onClick={() => setCurrentScreen('calendar')}
                        className={`flex flex-col items-center gap-1 transition-colors ${currentScreen === 'calendar' ? 'text-blue-500' : 'text-gray-400'}`}
                    >
                        <Calendar className="w-6 h-6" />
                        <span className="text-xs font-medium">Kalender</span>
                    </button>
                    <button 
                        onClick={() => setCurrentScreen('tasks')}
                        className={`flex flex-col items-center gap-1 transition-colors ${currentScreen === 'tasks' ? 'text-blue-500' : 'text-gray-400'}`}
                    >
                        <CheckCircle className="w-6 h-6" />
                        <span className="text-xs font-medium">Aufgaben</span>
                    </button>
                    <button 
                        onClick={() => setCurrentScreen('profile')}
                        className={`flex flex-col items-center gap-1 transition-colors ${currentScreen === 'profile' ? 'text-blue-500' : 'text-gray-400'}`}
                    >
                        <User className="w-6 h-6" />
                        <span className="text-xs font-medium">Profil</span>
                    </button>
                </div>
            );

            return (
                <div className="max-w-md mx-auto bg-white h-screen overflow-hidden" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
                    {currentScreen === 'dashboard' && <DashboardScreen />}
                    {currentScreen === 'tasks' && <TasksScreen />}
                    {currentScreen === 'calendar' && <CalendarScreen />}
                    {currentScreen === 'profile' && <ProfileScreen />}
                    <BottomNav />
                </div>
            );
        };

        try {
            console.log('Attempting to render app...');
            const root = document.getElementById('root');
            console.log('Root element found:', !!root);
            ReactDOM.render(<LernsystemApp />, root);
            console.log('App rendered successfully!');
        } catch (error) {
            console.error('Failed to render app:', error);
            document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red; font-family: monospace;">Failed to render app. Check console (F12) for details.<br><br>' + error.message + '</div>';
        }
    </script>
</body>
</html>
